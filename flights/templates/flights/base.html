<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}NASIM Airways{% endblock %}</title>
    {% block head_extras %}{% endblock %}
    <style>
      .chat-fab {
        position: fixed;
        right: 1rem;
        bottom: 1rem;
        z-index: 1200;
        border: 0;
        border-radius: 999px;
        padding: 0.78rem 1.1rem;
        font-weight: 700;
        color: #fff;
        cursor: pointer;
        background: linear-gradient(180deg, #4f0f24, #2e0814);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.25);
      }

      .chat-box {
        position: fixed;
        right: 1rem;
        bottom: 4.8rem;
        width: min(360px, calc(100vw - 2rem));
        background: #fffdf9;
        border: 1px solid #d9cbb4;
        border-radius: 14px;
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.25);
        overflow: hidden;
        display: none;
        z-index: 1200;
      }

      .chat-box.open {
        display: block;
      }

      .chat-head {
        background: linear-gradient(160deg, #4f0f24, #7f2a49);
        color: #fff;
        padding: 0.75rem 0.9rem;
      }

      .chat-head h3 {
        margin: 0;
        font-size: 1rem;
      }

      .chat-head p {
        margin: 0.2rem 0 0;
        font-size: 0.82rem;
        opacity: 0.95;
      }

      .chat-log {
        max-height: 220px;
        overflow-y: auto;
        padding: 0.75rem;
        background: #fffdf9;
      }

      .chat-row {
        margin-bottom: 0.55rem;
      }

      .chat-bubble {
        display: inline-block;
        border-radius: 10px;
        padding: 0.45rem 0.6rem;
        max-width: 92%;
        line-height: 1.35;
        font-size: 0.9rem;
      }

      .chat-user {
        text-align: right;
      }

      .chat-user .chat-bubble {
        background: #4f0f24;
        color: #fff;
      }

      .chat-bot .chat-bubble {
        background: #f4ebdd;
        color: #2a1f15;
      }

      .chat-form {
        border-top: 1px solid #e9dcc9;
        display: grid;
        gap: 0.55rem;
        padding: 0.7rem;
      }

      .chat-form input,
      .chat-form textarea {
        border: 1px solid #d8c6a9;
        border-radius: 8px;
        padding: 0.5rem;
        font: inherit;
      }

      .chat-form button {
        border: 1px solid #8a5f28;
        border-radius: 8px;
        background: linear-gradient(180deg, #d3a45d, #ad7b38);
        color: #fff9ee;
        padding: 0.5rem;
        font-weight: 700;
        cursor: pointer;
      }

      .chat-note {
        margin: 0;
        color: #6b5645;
        font-size: 0.78rem;
      }
    </style>
  </head>
  <body>
    {% block content %}{% endblock %}

    <button id="chatFab" class="chat-fab" type="button">Chat with us</button>
    <aside id="chatBox" class="chat-box" aria-label="Chat support">
      <div class="chat-head">
        <h3>NASIM Guest Care</h3>
        <p>Live help for booking, check-in, and refund questions.</p>
      </div>
      <div id="chatLog" class="chat-log"></div>
      <form id="chatForm" class="chat-form">
        <input id="chatName" type="text" name="name" placeholder="Your name" required />
        <input id="chatEmail" type="email" name="email" placeholder="Your email" required />
        <textarea id="chatMessage" name="message" rows="2" placeholder="How can we help?" required></textarea>
        <button type="submit">Send message</button>
        <p class="chat-note">When agents are offline, your message becomes a support ticket.</p>
      </form>
    </aside>

    <script>
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
        return "";
      }

      const chatFab = document.getElementById("chatFab");
      const chatBox = document.getElementById("chatBox");
      const chatForm = document.getElementById("chatForm");
      const chatLog = document.getElementById("chatLog");
      const chatName = document.getElementById("chatName");
      const chatEmail = document.getElementById("chatEmail");
      const chatMessage = document.getElementById("chatMessage");

      function appendChat(text, role = "bot") {
        const row = document.createElement("div");
        row.className = `chat-row chat-${role}`;

        const bubble = document.createElement("div");
        bubble.className = "chat-bubble";
        bubble.textContent = text;

        row.appendChild(bubble);
        chatLog.appendChild(row);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      appendChat("Hi. I can help with flight search, check-in windows, baggage, and refunds. Leave a message and our team follows up.");

      chatFab.addEventListener("click", () => {
        chatBox.classList.toggle("open");
      });

      chatForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        const payload = {
          name: chatName.value.trim(),
          email: chatEmail.value.trim(),
          message: chatMessage.value.trim(),
          source_page: window.location.pathname,
        };

        if (!payload.message) {
          return;
        }

        appendChat(payload.message, "user");
        chatMessage.value = "";

        try {
          const response = await fetch("/api/support/contact/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            appendChat("We could not save your request right now. Please try again in a minute.");
            return;
          }

          const data = await response.json();
          appendChat(data.reply || "Thanks. Our support team will contact you shortly.");
        } catch (error) {
          appendChat("Network issue detected. Please retry, or email support@nasim-airways.example");
        }
      });
    </script>
    {% block body_extras %}{% endblock %}
  </body>
</html>
